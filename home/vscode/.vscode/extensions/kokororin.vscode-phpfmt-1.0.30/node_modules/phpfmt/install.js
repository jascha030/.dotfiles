var path = require('path');
var fs = require('fs');
var fetch = require('node-fetch');
var sha1File = require('sha1-file');

var url = 'https://api.kotori.love/github/fmt.phar';
console.log('Fetching fmt.phar from: ' + url);

var destPath = path.join(__dirname, '/fmt.phar');

fetch(url)
  .then(function(res) {
    var dest = fs.createWriteStream(destPath, {
      autoClose: true
    });
    res.body.pipe(dest).on('finish', function() {
      if (sha1File(destPath) !== res.headers.get('X-Hash')) {
        console.error('Error installing fmt.phar: SHA1 mismatch');
        process.exit(1);
      } else {
        console.log('fmt.phar successfully installed!\n');
        process.exit(0);
      }
    });
  })
  .catch(function(err) {
    console.error('Error installing fmt.phar: ' + err.toString());
    process.exit(1);
  });
