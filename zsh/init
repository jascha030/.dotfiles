#!/usr/bin/env zsh

#######################################################################################################################
# By Jascha030                                  Dotfiles Initialization         https://github.io/jascha030/.dotfiles #
#######################################################################################################################

if ! (( ${+XDG_CONFIG} )); then 
    export XDG_CONFIG=${HOME}/.config
fi

# antigen.zsh path. based on simple install, overwrite if installed through brew.
if ! (( ${+DOT_ANTIGEN_PATH} )); then 
    export DOT_ANTIGEN_PATH=${HOME}/antigen.zsh
fi

# .antigenrc path.
if ! (( ${+DOT_ANTIGEN_RC_PATH} )); then 
    export DOT_ANTIGEN_RC_PATH=${HOME}/.antigenrc
fi

# Alternative dir for histfiles
if ! (( ${+DOT_DATA_DIR} )); then 
    export DOT_DATA_DIR=${XDG_CONFIG}/datafiles
fi

# Prompt height in lines
if ! (( ${DOT_PROMPT_HEIGHT} )); then 
    export DOT_PROMPT_HEIGHT=2
fi

#--------------------------------------------- Internally used functions ---------------------------------------------#

function __fpath_add {
    fpath=( "$@" ${fpath[@]} )
}


function __autoload {
    local a
    for a in "$@"; do
        [[ -d "$a" ]] && autoload -Uz ${a}/*(.:t)
    done
}

function __df_load_antigen {
    # Load or install antigen
    [[ ! -f "$1" ]] && curl -L git.io/antigen > "$1"
    # Sourze antigen.zsh 
    source "$1"
    # Load rc
    [[ -f "$2" ]] && antigen init "$2"
}

#--------------------------------------------------------- Init ------------------------------------------------------#

# Source files and autoload functions that are required early.
# Default directory for functions.
# Add by exporting (array) `DOT_AUTOLOAD_DIRS`.
local AUTOLOAD_DIRS=( "${DOT_ZFUNC}" )
(( ${+DOT_AUTOLOAD_DIRS} )) && $AUTOLOAD_DIRS=( "${AUTOLOAD_DIRS}" "${DOT_AUTOLOAD_DIRS[@]}" )

# Default directory for completions.
# Add by exporting (array) `DOT_COMP_DIRS`.
local COMP_DIRS=( "${DOT_ZSH}/completions" )
(( ${+DOT_COMP_DIRS} )) && COMP_DIRS=( "${COMP_DIRS[@]}" "${DOT_COMP_DIRS[@]}" )


fpath=( "${fpath[@]}" "${AUTOLOAD_DIRS[@]}" "${COMP_DIRS[@]}" )
__autoload_dirs "${AUTOLOAD_DIRS[@]}"

# Path
safe_source "${DOT_ZSH}/path"
typeset -aU path

# Source files that are required early.
if (( ${+DOT_SOURCES} )); then 
    safe_source "${DOT_SOURCES[@]}"
fi


# Lazy load functions that are only used conditionally.
# All functions reside in the default functions dir.

# Checks if directories or creates them using `mkdir -p`.
function assert_dirs {
    # undefined 
    builtin autoload -X
}

# Checks if files exist or creates them using `touch`.
function assert_files {
    # undefined 
    builtin autoload -X
}

# Display msg after load.
function lolmsg {
    # undefined
    builtin autoload -X
}

# Utility function, to merge arrays...
function merge_arrays {
    # undefined 
    builtin autoload -X
}

# Run and time zsh initialization 10 times.
function z_speedtest {
    # undefined
    builtin autoload -X
}

function source_dirs {
    # undefined 
    builtin autoload -X
}


# Assure required dirs exist.
(( ${+DOT_REQUIRED_DIRS} )) && assert_dirs "${DOT_REQUIRED_DIRS[@]}"  

# Assure required files exist.
(( ${+DOT_REQUIRED_FILES} )) && assert_files "${DOT_REQUIRED_FILES[@]}"

# Load antigen plugins.
__df_load_antigen

# Todo: figure out how to make this more dynamic.
eval "$(starship init zsh)"
eval "$(zoxide init zsh)"
eval "$(teleport-dir init)"
eval "$(fnm env)"

# Source other zsh dotfiles like aliases etc.
if (( ${+DOT_AFTER_INIT_SOURCES} )); then 
    safe_source "${DOT_AFTER_INIT_SOURCES[@]}"
fi

# Allow to turn off lolmsg when debugging.
(( ${+DOT_DISABLE_MSG} )) && unset DOT_DISABLE_MSG || lolmsg 
