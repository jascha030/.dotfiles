#!/usr/bin/env zsh

#######################################################################################################################
#                                                     Defaults
#######################################################################################################################


# Default directory for functions.
# 
# Add by exporting (array) `DOT_AUTOLOAD_DIRS`.
local AUTOLOAD_DIRS=( ${DOT_ZSH}/functions ) 

# Default directory for completions.
# 
# Add by exporting (array) `DOT_COMP_DIRS`.
local COMP_DIRS=( ${DOT_ZSH}/completions )


# Default sources.
#
# Files to be sourced before the ones added in `.zshrc`.
local _SOURCES=( ${DOT_ZSH}/path )


# ENV variables defaults, can be overwritten in .zshrc or any earlier config.


# Default antigen.zsh path.
# 
# Based on a normal install, overwrite if installed through brew.
if ! (( ${+DOT_ANTIGEN_PATH} )); then 
    export DOT_ANTIGEN_PATH="${HOME}/antigen.zsh"
fi

# Default antigenrc path.
#
# Prob. no reason to overwrite, 
# Antigen starts acting weird when rc not located @ $HOME.
if ! (( ${+DOT_ANTIGEN_RC_PATH} )); then 
    export DOT_ANTIGEN_RC_PATH="${HOME}/.antigenrc"
fi


# Lazy load functions that are only used conditionally.
# All functions reside in the default functions dir.



# functions for internal usage.
function __autoload_dirs {
    local a
    
    for a in "$@"; do
        autoload -Uz ${a}/*(.:t)
    done
}

# Load antigen plugins.
function __df_load_antigen {
    # Todo: check
    if [[ ! -f "$DOT_ANTIGEN_PATH" ]]; then 
        curl -L git.io/antigen > $DOT_ANTIGEN_PATH
    fi
  
    source "$DOT_ANTIGEN_PATH"

    if [[ -f "$DOT_ANTIGEN_RC_PATH" ]]; then 
        antigen init "$DOT_ANTIGEN_RC_PATH"
    fi
}

# Autoloads required and defined functions.
function df_load {
    # Bootstrap required dirs and files
    if (( ${+DOT_REQUIRED_DIRS} )); then 
        assert_dirs "${DOT_REQUIRED_DIRS[@]}"
    fi

    if (( ${+DOT_REQUIRED_FILES} )); then
        assert_files "${DOT_REQUIRED_FILES[@]}"
    fi


    # Merge defaults with user defined.
    (( ${+DOT_AUTOLOAD_DIRS} )) && $AUTOLOAD_DIRS=merge_arrays "$DOT_AUTOLOAD_DIRS" "$AUTOLOAD_DIRS"

    (( ${+DOT_COMP_DIRS} )) && $COMP_DIRS=merge_arrays "$DOT_COMP_DIRS" "$COMP_DIRS"
    
    (( ${+DOT_PLUGIN_DIRS} )) && $PLUGIN_DIRS=merge_arrays "$DOT_PLUGIN_DIRS" "$PLUGIN_DIRS"
    
    export fpath=( 
      "${AUTOLOAD_DIRS[@]}" 
      "${COMP_DIRS[@]}"
      "${PLUGIN_DIRS[@]}"
      "${fpath[@]}"
    )
    
    # Load stuff that needs to be loaded before Antigen
    __autoload_dirs "${AUTOLOAD_DIRS[@]}"

    # Source path
    safe_source "${_SOURCES}"

    # Source other zsh dotfiles
    if (( ${+DOT_SOURCES} )); then 
        safe_source "${DOT_SOURCES[@]}"
    fi

    __df_load_antigen
}

