#!/usr/bin/env zsh

set -eo pipefail

autoload -Uz colors
colors

typeset -g _INFO_PRINTED=0
typeset -g _ABORTED=0

_error() {
    print -P "%F{red}Error:%f $*" >&2
}

_info() {
    if (( _INFO_PRINTED )); then
        printf "\r\033[K"
    fi
    print -Pn "%F{cyan}$*%f"
    _INFO_PRINTED=1
}

_cleanup() {
    echoti cnorm 2>/dev/null || true
    if (( _ABORTED )); then
        print -P "\n%F{yellow}Aborted.%f"
    fi
}

_abort() {
    _ABORTED=1
    exit 130
}

# Hide cursor
echoti civis 2>/dev/null || true

trap _cleanup EXIT
trap _abort INT TERM

if ! command -v xz >/dev/null 2>&1; then
    _error "xz is not installed. Install it with: brew install xz"
    exit 1
fi

if (( $# != 1 )); then
    echo "Usage: $0 <folder-path>"
    exit 1
fi

INPUT_PATH="${1%/}"

if [[ ! -d "$INPUT_PATH" ]]; then
    _error "'$INPUT_PATH' is not a valid directory."
    exit 1
fi

BASENAME="$(basename "$INPUT_PATH")"

# Locale-aware, filename-safe timestamp
DATE_PART=$(date +"%x" | tr -cd '[:digit:]')
TIME_PART=$(date +"%H%M%S")
TIMESTAMP="${DATE_PART}_${TIME_PART}"

TAR_FILE="${BASENAME}_${TIMESTAMP}.tar"
FINAL_FILE="${TAR_FILE}.xz"

if [[ -e "$FINAL_FILE" || -e "$TAR_FILE" ]]; then
    _error "Output file already exists."
    exit 1
fi

# Get uncompressed size in bytes (macOS compatible)
SIZE=$(du -sk "$INPUT_PATH" | awk '{print $1 * 1024}')
START_TIME=$(date +%s)

_info "[1/2] Creating tar archive..."
tar -cf "$TAR_FILE" "$INPUT_PATH"

_info "[2/2] Compressing with maximum LZMA2..."
printf "\n"
xz -9 -e -T0 -v "$TAR_FILE"

for (( i=0; i<3; i++ )); do
    echoti cuu1 2>/dev/null || printf "\033[1A"
    echoti el 2>/dev/null  || printf "\033[K"
done

END_TIME=$(date +%s)
ELAPSED=$(( END_TIME - START_TIME ))

# Calculate compression ratio
COMPRESSED_SIZE=$(stat -f%z "$FINAL_FILE")
RATIO=$(awk "BEGIN { printf \"%.2f\", $COMPRESSED_SIZE / $SIZE * 100 }")

printf "âœ… Done: %s\n" "$FINAL_FILE"
printf "Original size:   %.2f MB\n" "$(awk "BEGIN {print $SIZE/1024/1024}")"
printf "Compressed size: %.2f MB\n" "$(awk "BEGIN {print $COMPRESSED_SIZE/1024/1024}")"
printf "Compression:     %s%% of original\n" "$RATIO"
printf "Time elapsed:    %ds\n" "$ELAPSED"

